#!/usr/bin/env node

const fs = require('fs');
const jsonlint = require('@mapbox/jsonlint-lines-primitives');

const { lint } = require('../dist/main');

const parseArguments = argv => {
  const args = argv.slice(2);
  const filepaths = [];

  args.forEach(v => {
    filepaths.push(v);
  });

  if (!filepaths.length) {
    console.error(`Could not find filepaths. Exiting.

Usage: ${process.argv[1]} files...`);
    process.exit(1);
  }

  return { filepaths };
};

const getErrorOutput = (file, error) => {
  return `${file}:${error.line}: ${error.message}`;
};

const { filepaths } = parseArguments(process.argv);

let errors = [];

filepaths.forEach(file => {
  fs.readFile(file, 'utf8', (err, data) => {
    if (err) {
      console.error(err);
      process.exit(1);
    }

    // Use jsonlint to get line numbers
    const style = jsonlint.parse(data);

    let styleErrors = lint(style);

    if (styleErrors) {
      styleErrors = styleErrors.map(e => getErrorOutput(file, e));
      errors = errors.concat(styleErrors);
    }
  });
});

if (errors.length) {
  errors.forEach(e => console.log(e));
  process.exit(1);
}
